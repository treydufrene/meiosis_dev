\input{preamble}
\begin{document}
\normalem
\input{coverpage}
\pagenumbering{roman}
% \begin{abstract}
%   Wordy words
% \end{abstract}
% {\tableofcontents\let\clearpage\relax\listoffigures\let\clearpage\relax}
{\tableofcontents\clearpage\listoffigures\listoftables}
\clearpage
\newpage
\section*{List Of Acronyms and Abbreviations}
\begin{tabular}{rl}
  FK & Forward Kinematics \\
  IK & Inverse Kinematics  \\
  PD & Proportional Derivative \\
  % $k$~:& Spring constant \\
  % $h_{b}$~:& Distance to bar ($G$) from datum \\
  % $F_s$~:& Force onto bar due to spring\\
  % $A_{n}$~:& Pin reaction in $\theta$ direction\\
  % $A_{t}$~:& Pin reaction in tangential direction \\
  % $\vec{v}_G$~:& Velocity of bar center of gravity\\
  % $\ddot{\theta}$~:& Angular velocity of spring \\
  % $\ddot{\phi}$~:& Angular velocity of bar\\
  % $\ddot{\ell}_s$~:& Radial acceleration of spring \\
\end{tabular}

\section*{Notation}\vspace{-\baselineskip}
\renewcommand{\arraystretch}{2.25}
\begin{tabular}{rcl}
\large%
\(
{}^{\text{\scriptsize Frame}}_{\text{\scriptsize From}}~{r}~_{\text{\scriptsize To}}
\)\normalsize && Direction Vectors\\
\(
{}^{\text{\scriptsize From}}~{T}~_{\text{\scriptsize To}}
\)\normalsize && Direction Cosine (Transformation) Matrices \\
\(c_{\theta_{nm}}\)& & \( \cos(\theta_n + \theta_m)\)\\
\(s_{\theta_{nm}}\)& & \( \sin(\theta_n + \theta_m)\) \\
\end{tabular}
\renewcommand{\arraystretch}{1}
\newpage

\pagenumbering{arabic}
\section{Introduction}
% TODO: Introduce the problem
\section{Requirements}
The requirements of the system concisely define the capabilities the system must possess in order to solve the stated problem.
\input{requirements}
\newpage
\section{Conceptual Design}
\input{concept}
\newpage
\section{Specifications}
\input{specs}
\newpage
\section{Preliminary Design}
\subsection{CAD}

\begin{figure}[htp]
  \center
  \includegraphics[width=.85\textwidth,frame]{callouts}
  \caption{Overall Model Render with Callouts}
  \label{fig:callouts}
\end{figure}
\begin{figure}[htp]
  \center
  \includegraphics[width=.85\textwidth,frame]{linkx}
  \caption{Link Cross Section}
  \label{fig:linkx}
\end{figure}
\begin{figure}[htp]
  \center
  \includegraphics[width=.85\textwidth,frame]{meiosis_zeroed}
  \caption{meiosis\_zeroed}
  \label{fig:meiosis_zeroed}
\end{figure}
\begin{figure}[htp]
  \center
  \includegraphics[width=.85\textwidth,frame]{meiosis}
  \caption{meiosis}
  \label{fig:meiosis}
\end{figure}
\newpage\null\newpage\null
\subsubsection{Pulleys}
A 12 tooth and 120 tooth pulleys provide a 10:1 gear ratio and use a 0.25 in wide MXL belt. The center distance between the pulleys must be at least 5.43 in to have 5 teeth meshing. Because of the high gear ratio, greater distances do not increase the number of teeth in mesh. \emph{Figure \ref{fig:pulley12}} shows the distance between the manipulatorâ€™s first two pulleys is 235.185 mm or 9.259 in, which corresponds to a belt with 300 and pitch diameter of 24 in.

\begin{figure}[htp]
  \center
  \includegraphics[width=.65\textwidth,frame]{pulley12}
  \caption{Pulley 1-2 Center Distance}
  \label{fig:pulley12}
\end{figure}
\emph{Figure \ref{fig:pulley3}} shows the center distance between the second pulleys is 139.960 mm or 5.510 in. The corresponding belt has 208 teeth with a 16.6 in pitch diameter.
\begin{figure}[htp]
  \center
  \includegraphics[width=.65\textwidth,frame]{pulley3}
  \caption{Pulley 3 Center Distance}
  \label{fig:pulley3}
\end{figure}


\newpage
\subsection{Forward Kinematics}
\input{fk}
\newpage
\subsection{Velocity Kinematics}
The translational and rotational velocties ($\dot{r}$ \& $\omega$) can be found given the geometric jacobian of the body and transformation matrix corresponding to it.
\[
\begin{bmatrix}
  ^B_B\omega_I\\
  ^I_B\dot{r}_B
\end{bmatrix}
= J_B =
\begin{bmatrix}
  ^IT_B(:,3)^T \cdot \dfrac{\partial}{\partial\gamma}{}^IT_B(:,2) \\
  ^IT_B(:,1)^T \cdot \dfrac{\partial}{\partial\gamma}{}^IT_B(:,3) \\
  ^IT_B(:,2)^T \cdot \dfrac{\partial}{\partial\gamma}{}^IT_B(:,1) \\
\end{bmatrix}
\]



\subsection{Inverse Kinematics}
The inverse kinematics can be calculated given desired position and orientation vectors, $o$ and $R$, respecitvely.
\[
\begin{bmatrix}x_c & y_c & z_c \end{bmatrix} = o~,\quad
  R =
  \begin{bmatrix}
    r_{11} & r_{12} & r_{13} \\
    r_{21} & r_{22} & r_{23} \\
    r_{31} & r_{32} & r_{33}
  \end{bmatrix}
\]
\begin{equation}
\begin{aligned}
\quad\text{Inverse Position}: \\
\theta_{1}&= \text{atan2} \left(x_{c},~ y_{c}\right) - \sfrac{\pi}{2}\\
\theta_{2}&= \text{atan2} \left(z_c - \ell_1, ~\sqrt{x_c^2 + y_c^2}\right) - \text{atan2}\left(\ell_3s_3,~\ell_2 + \ell_3c_3\right) \\
\theta_{3}&= \text{atan2} (-\sqrt{1-D^{2}},~ D) \\
& \quad \text { where } D\equiv\frac{x_{c}^{2}+y_{c}^{2}+\left(z_{c}-\ell_{1}\right)^{2}-\ell_{2}^{2}-\ell_{3}^{2}}{2 \ell_{2} \ell_{3}} \\
\quad\text{Inverse Orientation}:\\
^IT_3 &= rotz(\theta_1)~rotx(\theta_2)~rotx(\theta_3) \\
{}^3T_6 &= {}^IT_3^TR \\ % TODO: reference the FK orientation sec#/p.
\theta_4 &= \text{atan2} \left({}^3T_{6(1,2)},~{}^3T_{6(3,2)}\right) \\
\theta_5 &= \text{atan2} \left({{}^3T_{6(3,2)}} / {c_4},~{}^3T_{6(2,2)}\right) \\
\theta_6 &= \text{atan2} \left({}^3T_{6(2,1)},~ -{}^3T_{6(2,3)}\right) \\
\end{aligned}
\nonumber
\end{equation}
\newpage

\subsection{Equations of Motion}
Given robot dynamics described by \(H(\gamma) \ddot{\gamma}+d(\gamma, \dot{\gamma})+G(\gamma)=F_{\gamma},\) the equations of motion for
the manipulator can be determined. Solving this equation for \(\ddot{\gamma}\) gives:
\begin{equation}
  \ddot{\gamma}=H(\gamma)^{-1}\left(F_{\gamma}-d(\gamma, \dot{\gamma})-G(\gamma)\right)
  \label{eq:eoms}
\end{equation}
Where $F_{\gamma}$ is the vector of generalized forces on the joints and
\[
  \renewcommand{\arraystretch}{1.5}
  H(\gamma) = \sum_B^N J_B(\gamma)^T
  \begin{bmatrix}
    ^B_BJ & \mathring{S}(^B_B\Gamma) ^IT_B^T\\
    ^IT_B\mathring{S}(^B_B\Gamma)^T & m_BI
  \end{bmatrix}
  J_B(\gamma)~,\quad
  ^B_B\Gamma = ^B_Br_{cm}m_b~,\quad \mathring{S}(\omega)r=(\omega\times r)
\]
\[
  \renewcommand{\arraystretch}{1.5}
  d(\gamma,\dot{\gamma}) = \sum_B^N J_B(\gamma)^T
  \begin{bmatrix}
    ^B_BJ & \mathring{S}(^B_B\Gamma) ^IT_B^T\\
    ^IT_B\mathring{S}(^B_B\Gamma)^T & m_BI
  \end{bmatrix}
  \dot{J}_B(\gamma,\dot{\gamma})\dot{\gamma}+J_B(\gamma)^T
  \begin{bmatrix}
    ^B_B\omega_I \times ^B_BJ ^B_B\omega_I \\
    ^IT_B\left(^B_B\omega_I\times(^B_B\omega_I\times^B_B\Gamma)\right)
  \end{bmatrix}
\]
\[
G(\gamma) = \left(\frac{\partial U(^Ir(\gamma))}{\partial\gamma}\right)^T~,\quad U_B = \begin{bmatrix} 0 & 0 & g\end{bmatrix}\left(^I_Br_Bm_B + ^IT_B{}_B^B\Gamma\right)
\]
% \[
% ^B_B\Gamma = ^B_Br_{cm}m_b~,\quad \mathring{S}(\omega)r=(\omega\times r)
% \]
\subsubsection{Actuator Dynamics}
\input{motor}

\subsection{Open-Loop Simulation}
The equations of motion described in equation (\ref{eq:eoms}) can be integrated to simulate the motion of the system. For the open loop control, no input torque is supplied, meaning the system responds only to gravity. Due to the complexity of the equations of motion, they will be integrated numerically using a 4th Order Runge Kutta algorithm. Since so input force is supplied, the equations of motion reduce down to the relation described in equation (\ref{eq:eoms2}).
\begin{equation}
\ddot{\gamma}=H(\gamma)^{-1}(-d(\gamma, \dot{\gamma})-G(\gamma))
\label{eq:eoms2}
\end{equation}

\begin{figure}[htp]
  \center
  \begin{subfigure}[c]{0.5\textwidth}
  \center
  \includegraphics[width=.6\textwidth,frame]{olsnap1}
  \caption{Frame Snapshot near Simulation \\Initiation}
\end{subfigure}%
\begin{subfigure}[c]{0.5\textwidth}
  \center
  \includegraphics[width=.6\textwidth,frame]{olsnap2}
  \caption{Frame Snapshot near Simulation Termination}
\end{subfigure}
  \caption{Open-Loop Control Simulation Animation Snapshots}
  \label{fig:olsnaps}
\end{figure}


\begin{figure}[htp]
  \center
  \includegraphics[width=.95\textwidth]{oljplots}
  \caption{Joint Angles vs Time in Open-Loop Simulation}
  \label{fig:oljplots}
\end{figure}

\newpage
\subsection{Control System}
\newpage
\subsection{Closed-Loop Simulation}
The motor equation (\ref{eq:fin}) gives an expression for the motor torques, however the system dynamics are defined in terms of geometric joint angles. The inclusion of differential drive systems means that the joint angles, $\gamma$ do not directly correspond to motor rotations, $\theta$. However, there is a linear relation between them, described in equation (\ref{eq:A}).
\begin{equation}
  \gamma = A\cdot\theta\quad \text{where}~~A=\left[\begin{array}{cccccc}{1 /(2 N)} & {1 /(2 N)} & {0} & {0} & {0} & {0} \\ {1 /(2 N)} & {-1 /(2 N)} & {0} & {0} & {0} & {0} \\ {0} & {0} & {-1 / N} & {0} & {0} & {0} \\ {0} & {0} & {0} & {1} & {0} & {0} \\ {0} & {0} & {0} & {0} & {-1 / 2} & {1 / 2} \\ {0} & {0} & {0} & {0} & {1 / 2} & {1 / 2}\end{array}\right]
\label{eq:A}
\end{equation}
Equation (\ref{eq:A}) can be used to map the joint angles to the motor angles. The gear ratio of 1:10 is represented by the variable N. Similarly, the motor angles can be determined by multiplying both sides of equation (\ref{eq:A}) by the inverse of matrix A, giving the following relation.
\begin{equation}
\theta=A^{-1} \gamma
\label{eq:Ainv}
\end{equation}
It is important to note that the virtual work done by the joint torques ($F_{\gamma}$) and the virtual work done by the motor torques ($F_{\theta}$) are equal. Using equation (\ref{eq:Ainv}), a linear relation between the joint torques and motor torques can be determined.
\[
\begin{aligned}
  \delta W = F_{\theta}^{T} \delta \theta&=F_{\gamma}^{T} \delta \gamma, \text { where } \delta \gamma=A \delta \theta \\
  F_{\theta}^{T} \delta \theta &= F_{\gamma}^{T}(A \delta \theta) \\
  F_{\theta}^{T}&=F_{\gamma}^{T} A\\
  \left(F_{\theta}^{T}\right)^{T}&=\left(F_{\gamma}^{T} A\right)^{T}\\
  F_{\theta}=A^{T} F_{\gamma} &\Leftrightarrow F_{\gamma}=A^{-T} F_{\theta}\qquad\quad
\end{aligned}
\]
Using this equation, a relation can be determined between the motor dynamics and the system dynamics given in equation (\ref{eq:fin}) and equation (\ref{eq:eoms}) respectively.

\[
H(\gamma) \ddot{\gamma}+d(\gamma, \dot{\gamma})+G(\gamma)=-A^{-T}\left(C_1A^{-1} \ddot{\gamma}+C_2 A^{-1} \dot{\gamma}+C_3 \theta_{d}- C_3A^{-1} \gamma\right)
\]
\begin{equation}
\ddot{\gamma}=H(\gamma)^{-1}\left(-A^{-T}\left(C_1 A^{-1} \ddot{\gamma}+C_2 A^{-1} \dot{\gamma}+C_3 \theta_{d}-C_3A^{-1} \gamma\right)-d(\gamma, \dot{\gamma})-G(\gamma)\right)
\label{eq:gddot}
\end{equation}

Because this equation includes the motor model, which in turn includes an internal PD controller, this equation can be integrated to solve for the system response given a desired motor angle input, $\theta_d$. However, doing so will not result in the desired system response. This control scheme does not have any compensation for the inertia of the links, and it is also lacking gravity compensation. This can be remedied by modifying the input to the motors, $\theta_d$. A new input, $u$, is defined such that gravity can be compensated. Thus, the motor input term in equation (\ref{eq:gddot}) must include both compensation for gravity and the desired motor angle.
\[
A^{-T} C_3  u=G(\gamma)+d(\gamma, \dot{\gamma})+A^{-T} C_3\theta_{d}
\]
\begin{equation}
u=\left(A^{-T} C_3\right)^{-1} G(\gamma)+\theta_{d}
\end{equation}
With this new motor input, the closed loop control system equations of motion are given as:
\begin{equation}
\ddot{\gamma}=H(\gamma)^{-1}\left(-A^{-T}\left(C_1 A^{-1} \ddot{\gamma}+C_2 A^{-1} \dot{\gamma}+C_3 u-C_3A^{-1} \gamma\right)-d(\gamma, \dot{\gamma})-G(\gamma)\right)
\label{eq:gddotfin}
\end{equation}
Equation (\ref{eq:gddotfin}) can then be integrated to solve for the system response given desired motor angles.

\begin{figure}[htp]
  \center
  \begin{subfigure}[c]{0.33\textwidth}
    \center
    \includegraphics[width=.9\textwidth,frame]{clsnap1}
    \caption{Frame Snapshot near Simulation \\Initiation}
  \end{subfigure}%
  \begin{subfigure}[c]{0.33\textwidth}
    \center
    \includegraphics[width=.9\textwidth,frame]{clsnap2}
    \caption{Frame Snapshot near Simulation \\Middle}
  \end{subfigure}%
\begin{subfigure}[c]{0.33\textwidth}
  \center
  \includegraphics[width=.9\textwidth,frame]{clsnap3}
  \caption{Frame Snapshot near Simulation \\Termination}
\end{subfigure}
  \caption{Closed-Loop Control Simulation Animation Snapshots}
  \label{fig:clsnaps}
\end{figure}
% The closed-loop system can now be simulated, the results are shown below in Figure (\ref{fig:jplots}).
\begin{figure}[htp]
  \center
  \includegraphics[width=.95\textwidth]{cljplots}
  \caption{Joint Angles vs Time in Closed-Loop Simulation}
  \label{fig:cljplots}
\end{figure}

% \[
% \delta W = \delta\gamma = \delta\theta
% \]

\newpage
\subsection{ANSYS}
\newpage
\subsection{Electrical Schematic}

\begin{figure}[htp]
  \centering
  \includegraphics[width=.95\textwidth]{eschem}
  \caption{Electrical Schematic}
\end{figure}

% \begin{table}[htp]
%   \caption{Power Supply Analysis}
% \begin{tabular}{lc}
%   Motor 1 &
% \end{tabular}
% \end{table}

\newpage
\subsection{Software Flowchart}


% \includepdf[landscape,pages=-]{sflow}

\subsection{Project Status and Future}
\newpage
\subsection{Parts List}




% \begin{enumerate}[label=\alph*.]
%   \item Description for callout a
%   \item Description for callout b
% \end{enumerate}

% Example citations:
% \cite{DBLP:journals/corr/JohnsonAL16}
% \cite{DBLP:journals/corr/abs-1803-09820}
% \cite{DBLP:journals/corr/RonnebergerFB15}

% \newpage
% \bibliographystyle{plain}
% \bibliography{JohnsonAL16,abs-1803-09820,RonnebergerFB15}

\newpage
\section*{Acknowledgements \& Attributions}
We would like to acknowledge the following people for their contibutions in creating this report\textbf{?}
\begin{itemize}
  \item Dr. Isenberg
  \item Dr. Schipper
\end{itemize}
\newpage
\bibliographystyle{plainnat}
\bibliography{robo}

\newpage
\appendix
\renewcommand\thesection{\Roman{section}}
\renewcommand\thesubsection{\roman{subsection}}
% \hiddenappsec{Appendix}\label{sec:app}
\section{Appendix}\label{sec:app}
% \hiddenappsub{Relevant Figures and Materials}
\subsection{Relevant Figures and Materials}
\begin{figure}[htp]
  \centering
  \includegraphics[frame,width=.75\textwidth]{dex}
  \caption{Cross Section of Dexterous Workspace Quadrant}
  \label{fig:dex}
\end{figure}
% \hiddenappsub{CAD Drawings}
\subsection{CAD Drawings}
The complete drawing package is attached.
\includepdf[landscape,pages=-]{drawings}
% \hiddenappsub{Salient Code}
\subsection{Salient Code}
\input{mmodel}
\vspace{10ex}

\input{meiosisfk}
\vspace{10ex}

\input{meiosisik}
\vspace{10ex}

% Code listing
%\begin{lstlisting}[frame=lines,style=Matlab-editor,basicstyle = \mlttfamily, caption=Example Code]
% Code Here
%\end{lstlisting}
% \includepdf[landscape,pages=-]{pdfname}

\end{document}
